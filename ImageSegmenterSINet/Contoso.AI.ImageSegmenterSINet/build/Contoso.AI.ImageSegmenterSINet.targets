<Project>
  <PropertyGroup>
    <!-- Configure these for the SINet models -->
    <FloatModelUrl>https://huggingface.co/qualcomm/SINet/resolve/v0.45.0/SINet_float.onnx.zip</FloatModelUrl>
    <FloatModelZipFileName>SINet_float.onnx.zip</FloatModelZipFileName>
    <FloatModelFileName>model.onnx</FloatModelFileName>
    <FloatModelFolderName>float</FloatModelFolderName>
    
    <QuantizedModelUrl>https://huggingface.co/qualcomm/SINet/resolve/v0.45.0/SINet_w8a8.onnx.zip</QuantizedModelUrl>
    <QuantizedModelZipFileName>SINet_w8a8.onnx.zip</QuantizedModelZipFileName>
    <QuantizedModelFileName>model.onnx</QuantizedModelFileName>
    <QuantizedModelFolderName>quantized</QuantizedModelFolderName>
    
    <ModelFolderName>SINet</ModelFolderName>
    
    <!-- Download to obj directory to avoid source control pollution -->
    <ModelDirectory>$(MSBuildProjectDirectory)\obj\Models</ModelDirectory>
    <ModelExtractDirectory>$(ModelDirectory)\$(ModelFolderName)</ModelExtractDirectory>
    <FloatModelExtractDirectory>$(ModelExtractDirectory)\$(FloatModelFolderName)</FloatModelExtractDirectory>
    <QuantizedModelExtractDirectory>$(ModelExtractDirectory)\$(QuantizedModelFolderName)</QuantizedModelExtractDirectory>
  </PropertyGroup>

  <!-- Download float model at build time -->
  <Target Name="DownloadImageSegmenterSINetFloatModel" BeforeTargets="BeforeBuild">
    <PropertyGroup>
      <FloatModelZipFilePath>$(ModelDirectory)\$(FloatModelZipFileName)</FloatModelZipFilePath>
      <FloatModelFilePath>$(FloatModelExtractDirectory)\$(FloatModelFileName)</FloatModelFilePath>
    </PropertyGroup>
    
    <!-- Create directories -->
    <MakeDir Directories="$(ModelDirectory)" Condition="!Exists('$(ModelDirectory)')" />
    <MakeDir Directories="$(FloatModelExtractDirectory)" Condition="!Exists('$(FloatModelExtractDirectory)')" />
    
    <!-- Status messages -->
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Checking for float model at: $(FloatModelFilePath)" Importance="high" />
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Float model already exists, skipping download." 
             Importance="high" Condition="Exists('$(FloatModelFilePath)')" />
    
    <!-- Download ZIP file -->
    <DownloadFile 
      SourceUrl="$(FloatModelUrl)" 
      DestinationFolder="$(ModelDirectory)"
      DestinationFileName="$(FloatModelZipFileName)"
      Condition="!Exists('$(FloatModelFilePath)')"
      SkipUnchangedFiles="true" />
      
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Float model ZIP downloaded successfully" 
             Importance="high" 
             Condition="!Exists('$(FloatModelFilePath)') AND Exists('$(FloatModelZipFilePath)')" />
    
    <!-- Extract ZIP file to temp directory -->
    <Unzip 
      SourceFiles="$(FloatModelZipFilePath)" 
      DestinationFolder="$(ModelDirectory)\temp_float"
      Condition="!Exists('$(FloatModelFilePath)') AND Exists('$(FloatModelZipFilePath)')" />
      
    <!-- Find all files in the extracted job folder -->
    <ItemGroup>
      <ExtractedFloatFiles Include="$(ModelDirectory)\temp_float\**\*.*" />
    </ItemGroup>
    
    <!-- Copy all files to the float directory, flattening the structure -->
    <Copy
      SourceFiles="@(ExtractedFloatFiles)"
      DestinationFiles="@(ExtractedFloatFiles->'$(FloatModelExtractDirectory)\%(Filename)%(Extension)')"
      Condition="!Exists('$(FloatModelFilePath)')" />
      
    <!-- Clean up temp directory -->
    <RemoveDir Directories="$(ModelDirectory)\temp_float" Condition="Exists('$(ModelDirectory)\temp_float')" />
      
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Float model extracted successfully to $(FloatModelExtractDirectory)" 
             Importance="high" Condition="Exists('$(FloatModelFilePath)')" />
    
    <!-- Add all model files to output (ONNX and any external data files) -->
    <ItemGroup>
      <FloatModelContentFiles Include="$(FloatModelExtractDirectory)\*.*" />
    </ItemGroup>
    
    <ItemGroup>
      <Content Include="@(FloatModelContentFiles)" Condition="Exists('$(FloatModelFilePath)')">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Link>Models\$(ModelFolderName)\$(FloatModelFolderName)\%(Filename)%(Extension)</Link>
      </Content>
    </ItemGroup>
  </Target>

  <!-- Download quantized model at build time -->
  <Target Name="DownloadImageSegmenterSINetQuantizedModel" BeforeTargets="BeforeBuild">
    <PropertyGroup>
      <QuantizedModelZipFilePath>$(ModelDirectory)\$(QuantizedModelZipFileName)</QuantizedModelZipFilePath>
      <QuantizedModelFilePath>$(QuantizedModelExtractDirectory)\$(QuantizedModelFileName)</QuantizedModelFilePath>
    </PropertyGroup>
    
    <!-- Create directories -->
    <MakeDir Directories="$(ModelDirectory)" Condition="!Exists('$(ModelDirectory)')" />
    <MakeDir Directories="$(QuantizedModelExtractDirectory)" Condition="!Exists('$(QuantizedModelExtractDirectory)')" />
    
    <!-- Status messages -->
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Checking for quantized model at: $(QuantizedModelFilePath)" Importance="high" />
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Quantized model already exists, skipping download." 
             Importance="high" Condition="Exists('$(QuantizedModelFilePath)')" />
    
    <!-- Download ZIP file -->
    <DownloadFile 
      SourceUrl="$(QuantizedModelUrl)" 
      DestinationFolder="$(ModelDirectory)"
      DestinationFileName="$(QuantizedModelZipFileName)"
      Condition="!Exists('$(QuantizedModelFilePath)')"
      SkipUnchangedFiles="true" />
      
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Quantized model ZIP downloaded successfully" 
             Importance="high" 
             Condition="!Exists('$(QuantizedModelFilePath)') AND Exists('$(QuantizedModelZipFilePath)')" />
    
    <!-- Extract ZIP file to temp directory -->
    <Unzip 
      SourceFiles="$(QuantizedModelZipFilePath)" 
      DestinationFolder="$(ModelDirectory)\temp_quantized"
      Condition="!Exists('$(QuantizedModelFilePath)') AND Exists('$(QuantizedModelZipFilePath)')" />
      
    <!-- Find all files in the extracted job folder -->
    <ItemGroup>
      <ExtractedQuantizedFiles Include="$(ModelDirectory)\temp_quantized\**\*.*" />
    </ItemGroup>
    
    <!-- Copy all files to the quantized directory, flattening the structure -->
    <Copy
      SourceFiles="@(ExtractedQuantizedFiles)"
      DestinationFiles="@(ExtractedQuantizedFiles->'$(QuantizedModelExtractDirectory)\%(Filename)%(Extension)')"
      Condition="!Exists('$(QuantizedModelFilePath)')" />
      
    <!-- Clean up temp directory -->
    <RemoveDir Directories="$(ModelDirectory)\temp_quantized" Condition="Exists('$(ModelDirectory)\temp_quantized')" />
      
    <Message Text="[Contoso.AI.ImageSegmenterSINet] Quantized model extracted successfully to $(QuantizedModelExtractDirectory)" 
             Importance="high" Condition="Exists('$(QuantizedModelFilePath)')" />
    
    <!-- Add all model files to output (ONNX and any external data files like model.data) -->
    <ItemGroup>
      <QuantizedModelContentFiles Include="$(QuantizedModelExtractDirectory)\*.*" />
    </ItemGroup>
    
    <ItemGroup>
      <Content Include="@(QuantizedModelContentFiles)" Condition="Exists('$(QuantizedModelFilePath)')">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Link>Models\$(ModelFolderName)\$(QuantizedModelFolderName)\%(Filename)%(Extension)</Link>
      </Content>
    </ItemGroup>
  </Target>
</Project>
